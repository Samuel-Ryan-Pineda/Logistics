<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Logistics Couriers</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <header class="d-flex justify-content-between align-items-center container mx-auto mb-4">
    <div class="d-flex align-items-center">
      <div class="logo-circle">
        <span>Lo</span>
      </div>
      <div class="logo-text">gistics</div>
    </div>
    <nav class="d-flex gap-3">
      <a href="customer.html" type="button" class="nav-btn nav-btn-secondary">
        <i class="fas fa-user"></i>
        Customer
      </a>
      <a href="orderdetails.html" type="button" class="nav-btn nav-btn-secondary">
        <i class="fas fa-shopping-cart"></i>
        Order Details
      </a>
      <a href="courier.html" type="button" class="nav-btn nav-btn-primary">
        <i class="fas fa-truck"></i>
        Courier
      </a>
    </nav>
  </header>

  <main class="main container mx-auto bg-white rounded-2 p-4 flex-grow-1">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="fw-normal" style="font-size: 1.25rem; background-color: #1e2a4718; padding: 0.4rem;">Couriers</h2>
      <button type="button" class="btn-add-customer" data-bs-toggle="modal" data-bs-target="#addCourierModal">
        <i class="fas fa-plus"></i>
        Add Courier
      </button>
    </div>
    <table class="table mb-0">
      <thead>
        <tr>
          <th scope="col" class="text-start ps-3">Delivery Hub</th>
          <th scope="col" class="text-start ps-3">Courier</th>
          <th scope="col" class="text-start ps-3">Phone</th>
          <th scope="col" class="text-start ps-3">Rating</th>
          <th scope="col" class="text-center ps-3">Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Courier data will be loaded dynamically -->
      </tbody>
    </table>
  </main>

  <!-- Add Courier Modal -->
  <div class="modal fade" id="addCourierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content form-container">
        <form aria-label="Add Courier Form" id="addCourierForm" class="needs-validation" novalidate>
          <h2 class="form-title">Add Courier</h2>
          <div class="mb-3">
            <label for="courierName" class="form-label">Courier Name</label>
            <input type="text" class="form-control" id="courierName" name="courierName" autocomplete="off" required />
          </div>
          <div class="mb-3">
            <label for="phoneNumber" class="form-label">Phone Number</label>
            <div class="input-group">
              <span class="input-group-text">+63</span>
              <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" autocomplete="off" maxlength="10" pattern="\d{10}" title="Please enter exactly 10 digits" onkeypress="return event.charCode >= 48 && event.charCode <= 57" required  />
            </div>
          </div>
          <div class="mb-3">
            <label for="deliveryHub" class="form-label">Delivery Hub</label>
            <select class="form-select" id="deliveryHub" name="deliveryHub" required>
              <option value="">Select Hub</option>
              <option value="Kapitan Pepe Delivery Hub">Kapitan Pepe Delivery Hub</option>
              <option value="Mabini Homesite Delivery Hub">Mabini Homesite Delivery Hub</option>
              <option value="D.S. Garcia Delivery Hub">D.S. Garcia Delivery Hub</option>
              <option value="Sangitan East Delivery Hub">Sangitan East Delivery Hub</option>
              <option value="Bangad Delivery Hub">Bangad Delivery Hub</option>
              <option value="Palagay Delivery Hub">Palagay Delivery Hub</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="rating" class="form-label">Initial Rating</label>
            <select class="form-select" id="rating" name="rating">
              <option value="">Select Rating</option>
              <option value="5">5 ★</option>
              <option value="4">4 ★</option>
              <option value="3">3 ★</option>
              <option value="2">2 ★</option>
              <option value="1">1 ★</option>
            </select>
          </div>
          <div class="d-flex justify-content-end gap-3">
            <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-add">Add Courier</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Assign Order Delivery Modal -->
  <div class="modal fade" id="assignOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content form-container">
        <form aria-label="Assign Order Form" novalidate>
          <h1 class="mb-4" style="font-weight: 400; font-size: 1.5rem;">Assign Order Delivery</h1>

          <div class="customer-info mb-4">
            <div class="d-flex">
              <dt class="me-2">Courier:</dt>
              <dd id="selectedCourierName"></dd>
            </div>
            <div class="d-flex">
              <dt class="me-2">Phone Number:</dt>
              <dd id="selectedCourierPhone"></dd>
            </div>
            <div class="d-flex">
              <dt class="me-2">Delivery Hub:</dt>
              <dd id="selectedCourierHub"></dd>
            </div>
          </div>

          <div class="unassigned-orders mb-4">
            <h5 class="mb-3">Unassigned Orders</h5>
            <div id="unassignedOrdersList" class="list-group">
              <!-- Unassigned orders will be loaded here -->
            </div>
          </div>

          <div class="d-flex justify-content-end gap-3">
            <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn-add">Assign Selected Orders</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    loadCouriers();

    const addCourierForm = document.querySelector('#addCourierForm');
    addCourierForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Add validation class to show feedback
      this.classList.add('was-validated');
      
      if (!this.checkValidity()) {
        e.stopPropagation();
        return;
      }
      
      // Create FormData object 
      const formData = new FormData();
      
      // Add courier information to formData
      formData.append('courierName', document.getElementById('courierName').value);
      formData.append('phoneNumber', '+63' + document.getElementById('phoneNumber').value);
      formData.append('deliveryHub', document.getElementById('deliveryHub').value);
  
      // Only append rating if a value is selected
      const ratingValue = document.getElementById('rating').value;
      if (ratingValue) {
        formData.append('rating', ratingValue);
      }
      fetch('../php/addcourier.php', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Create and show toast notification
          const toastHTML = `
            <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-2">
              <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #d4edda; color: #155724; border-color: #c3e6cb; border-radius: 4px; padding: 0.75rem 1.25rem; display: flex; align-items: center; justify-content: space-between; width: 450px;">
                <div class="toast-body d-flex align-items-center">
                  <i class="fas fa-check-circle me-2" style="color: #155724;"></i>
                  <span>Success: Courier added successfully!</span>
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" style="font-size: 0.875rem; opacity: 0.8;"></button>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', toastHTML);
          
          bootstrap.Modal.getInstance(document.getElementById('addCourierModal')).hide();
          addCourierForm.reset();
          addCourierForm.classList.remove('was-validated');
          loadCouriers();
          
          // Remove toast after 5 seconds
          setTimeout(() => {
            const toast = document.querySelector('.toast-container');
            if (toast) toast.remove();
          }, 5000);
        } else {
          // Create and show error toast notification
          const toastHTML = `
            <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-2">
              <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; border-radius: 4px; padding: 0.75rem 1.25rem; display: flex; align-items: center; justify-content: space-between; width: 450px;">
                <div class="toast-body d-flex align-items-center">
                  <i class="fas fa-exclamation-circle me-2" style="color: #721c24;"></i>
                  <span>Error: ${data.error}</span>
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" style="font-size: 0.875rem; opacity: 0.8;"></button>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', toastHTML);
          
          // Remove toast after 5 seconds
          setTimeout(() => {
            const toast = document.querySelector('.toast-container');
            if (toast) toast.remove();
          }, 5000);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to add courier');
      });
    });
  });

  function loadCouriers() {
    fetch('../php/getcouriers.php')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const tbody = document.querySelector('table tbody');
          tbody.innerHTML = '';
          
          data.couriers.forEach(courier => {
            const tr = document.createElement('tr');
            
            // Create a JSON string of courier data for the onclick handler
            const courierJSON = JSON.stringify(courier).replace(/"/g, '&quot;');
            
            tr.innerHTML = `
              <td class="text-start ps-3">${courier.deliveryHub}</td>
              <td class="text-start ps-3">${courier.courierName}</td>
              <td class="text-start ps-3">${courier.phoneNumber}</td>
              <td class="text-start ps-3">${courier.rating}</td>
              <td class="text-center">
                <button type="button" class="btn-add-order" data-bs-toggle="modal" data-bs-target="#assignOrderModal"
                  onclick="loadUnassignedOrders('${courier.id}', ${courierJSON})">
                  Assign Order Delivery
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          console.error('Error loading couriers:', data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to load couriers');
      });
  }

  function loadUnassignedOrders(courierId, courierInfo) {
    // Update courier info in modal
    document.getElementById('selectedCourierName').textContent = courierInfo.courierName;
    document.getElementById('selectedCourierPhone').textContent = courierInfo.phoneNumber;
    document.getElementById('selectedCourierHub').textContent = courierInfo.deliveryHub;

    // Fetch unassigned orders
    fetch('../php/getunassignedorders.php')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const ordersList = document.getElementById('unassignedOrdersList');
          ordersList.innerHTML = '';
          
          if (data.orders.length === 0) {
            ordersList.innerHTML = '<div class="alert alert-info">No unassigned orders available.</div>';
            return;
          }
          
          data.orders.forEach(order => {
            const orderItem = document.createElement('div');
            orderItem.className = 'list-group-item';
            orderItem.innerHTML = `
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${order._id}" id="order_${order._id}">
                <label class="form-check-label w-100" for="order_${order._id}">
                  <div class="d-flex flex-column">
                    <div class="d-flex justify-content-between">
                      <strong>${order.customer.name}</strong>
                      <span class="text-muted">₱${order.amount}</span>
                    </div>
                    <div class="text-muted small">
                      <div>${order.customer.phone || 'No phone provided'}</div>
                      <div>${order.customer.address || 'No address provided'}</div>
                      <div>Item: ${order.item} (Qty: ${order.quantity}, Weight: ${order.weight})</div>
                    </div>
                  </div>
                </label>
              </div>
            `;
            ordersList.appendChild(orderItem);
          });

          // Clear any previous event listeners
          const assignOrderForm = document.querySelector('#assignOrderModal form');
          const newForm = assignOrderForm.cloneNode(true);
          assignOrderForm.parentNode.replaceChild(newForm, assignOrderForm);
          
          // Add new event listener
          newForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedOrders = Array.from(document.querySelectorAll('#unassignedOrdersList input[type="checkbox"]:checked'))
              .map(checkbox => checkbox.value);

            if (selectedOrders.length === 0) {
              alert('Please select at least one order to assign.');
              return;
            }

            const formData = new FormData();
            formData.append('courierId', courierId);
            selectedOrders.forEach(orderId => {
                formData.append('orderIds[]', orderId);
            });

            fetch('../php/assignorders.php', {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Create and show toast notification
                const toastHTML = `
                  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-2">
                    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #d4edda; color: #155724; border-color: #c3e6cb; border-radius: 4px; padding: 0.75rem 1.25rem; display: flex; align-items: center; justify-content: space-between; width: 450px;">
                      <div class="toast-body d-flex align-items-center">
                        <i class="fas fa-check-circle me-2" style="color: #155724;"></i>
                        <span>Success: ${data.modifiedCount} orders assigned successfully!</span>
                      </div>
                      <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" style="font-size: 0.875rem; opacity: 0.8;"></button>
                    </div>
                  </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', toastHTML);
                
                bootstrap.Modal.getInstance(document.getElementById('assignOrderModal')).hide();
                loadCouriers(); // Refresh the couriers list
                
                // Remove toast after 5 seconds
                setTimeout(() => {
                  const toast = document.querySelector('.toast-container');
                  if (toast) toast.remove();
                }, 5000);
              } else {
                alert('Error: ' + data.error);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Failed to assign orders');
            });
          });
        } else {
          console.error('Error loading unassigned orders:', data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to load unassigned orders');
      });
  }
  </script>
</body>
</html>