<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Logistics Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <header class="d-flex justify-content-between align-items-center container mx-auto mb-4 ,ao">
    <div class="d-flex align-items-center">
      <div class="logo-circle">
        <span>Lo</span>
      </div>
      <div class="logo-text">gistics</div>
    </div>
    <nav class="d-flex gap-3">
      <a href="customer.html" type="button" class="nav-btn nav-btn-secondary">
        <i class="fas fa-user"></i>
        Customer
      </a>
      <a href="orderdetails.html" type="button" class="nav-btn nav-btn-primary">
        <i class="fas fa-shopping-cart"></i>
        Order Details
      </a>
      <a href="courier.html" type="button" class="nav-btn nav-btn-secondary">
        <i class="fas fa-truck"></i>
        Courier
      </a>
    </nav>
  </header>

  <main class="main container mx-auto bg-white rounded-2 p-4 flex-grow-1">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="fw-normal" style="font-size: 1.25rem; background-color: #1e2a4718; padding: 0.4rem;">Order Details</h2>
    </div>
    <table class="table mb-0">
      <thead>
        <tr>
          <th scope="col" class="text-start ps-3">Ordered By</th>
          <th scope="col" class="text-start ps-3">Item</th>
          <th scope="col" class="text-start ps-3">Quantity</th>
          <th scope="col" class="text-start ps-3">Amount</th>
          <th scope="col" class="text-start ps-3">Weight</th>
          <th scope="col" class="text-start ps-3">Status</th>
          <th scope="col" class="text-start ps-3">Courier</th>
          <th scope="col" class="text-start ps-3">Date Delivered</th>
          <th scope="col" class="text-start ps-3">Action</th>
        </tr>
      </thead>
      <tbody id="orders-table-body">
      </tbody>
    </table>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Function to handle marking order as delivered
      function markOrderAsDelivered(orderId) {
        const formData = new FormData();
        formData.append('orderId', orderId);

        fetch('../php/markdelivered.php', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Refresh the orders list
            loadOrders();
          } else {
            console.error('Error:', data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      }

      // Function to load orders
      function loadOrders() {
      fetch('../php/getorders.php')
        .then(response => response.json())
        .then(data => {
          if (data.success && Array.isArray(data.orders)) {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '';
            data.orders.forEach(order => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="text-start ps-3 fw-bold">${order.customer.name}</td>
                <td class="text-start ps-3">${order.item}</td>
                <td class="text-start ps-3">${order.quantity}</td>
                <td class="text-start ps-3">â‚±${order.amount}</td>
                <td class="text-start ps-3">${order.weight}</td>
                <td class="text-start ps-3">${order.status}</td>
                <td class="text-start ps-3 fw-bold">${order.courier}</td>
                <td class="text-start ps-3">${order.dateDelivered || '-'}</td>
                <td class="text-start ps-3">
                  ${order.status !== 'delivered' ? 
                    (order.courier && order.courier.trim() !== '-' ? `
                      <button class="btn btn-sm btn-success mark-delivered-btn" data-order-id="${order._id}">
                        <i class="fas fa-check"></i> Mark Delivered
                      </button>
                    ` : `
                      <span class="text-muted">
                        <i class="fas fa-truck"></i> No Courier Assigned
                      </span>
                    `) : `
                      <span class="text-success">
                        <i class="fas fa-check-circle"></i> Delivered
                      </span>
                    `}
                </td>
              `;
              tbody.appendChild(tr);
            });

            // Bind click listeners AFTER DOM has updated
            document.querySelectorAll('.mark-delivered-btn').forEach(button => {
              button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                markOrderAsDelivered(orderId);
              });
            });

          } else {
            console.error('Error: Invalid data format received', data);
          }
        })
        .catch(error => {
          console.error('Error fetching orders:', error);
        });
    }

    // Load orders when page loads
    loadOrders();
    });
  </script>
</body>
</html>
